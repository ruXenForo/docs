# Инструменты разработки

XF2 предоставляет разработчикам ряд встроенных инструментов, которые Вы можете использовать для ускорения разработки дополнений, и мы рассмотрим некоторые из них ниже.

## Режим отладки

Режим отладки может быть включен в Вашем `config.php`, что позволит Вам получить доступ к определенным инструментам разработки в Admin CP (таким как создание маршрутов, разрешений, административная навигация и т. д.), А также позволит выводить в нижней части каждой страницы, в котором подробно указано, сколько времени потребовалось для обработки страницы, сколько запросов было выполнено для отображения страницы и сколько памяти было использовано. Всплывающая подсказка, содержащая информацию о текущем контроллере, действии и имени шаблона, доступна при наведении курсора. Вы также можете щелкнуть вывод времени, и это даст Вам подробное представление о том, какие именно запросы выполнялись, и трассировку стека, которая привела к выполнению этого запроса.

Вы можете включить режим отладки, добавив следующее в `config.php`:

```php
$config['debug'] = true;
```

## Включение режима разработки

Режим разработки - это специальный режим, активированный в Вашем файле `config.php`, который заставит XF автоматически записать Ваши файлы разработки в Ваш каталог `_output`. Этот режим должен быть включен, чтобы было разрешено редактирование шаблона файловой системы. Поскольку режим разработки будет записывать файлы в Вашу файловую систему, важно убедиться, что у Вас есть соответствующие права доступа к файлам. Это может варьироваться в зависимости от среды, но типичная конфигурация должна гарантировать, что для любого дополнения, над которым Вы работаете, у Вас есть каталог `_output`, установленный chmod `0777`. Например, если Вы работаете над дополнением с идентификатором `Demo`, его результаты разработки будут записаны в `src/addons/Demo/_output`, и поэтому этот каталог должен быть полностью доступен для записи.

Включение режима разработки также автоматически включает [режим отладки](#debug-mode).

Чтобы включить режим разработки, добавьте следующие строки в Ваш файл `config.php`:

```php
$config['development']['enabled'] = true;
$config['development']['defaultAddOn'] = 'SomeCompany/MyAddOn';
```

Значение `defaultAddOn` является необязательным, но его добавление автоматически заполнит указанное дополнение в XF Admin CP при создании нового контента, который будет связан с дополнением.

В дополнение к вышесказанному Вам может потребоваться добавить некоторую дополнительную конфигурацию, особенно если Вы используете более одной установки XF.

```php
$config['enableMail'] = false;
```

Это отключит отправку всей почты с Вашего форума. Это особенно важно, если Вы используете копию живых данных с реальными пользователями и реальными адресами электронной почты (хотя мы бы не советовали этого!).

В качестве альтернативы непосредственному отключению почты Вы можете рассмотреть возможность использования такой службы, как [MailTrap.io](https://mailtrap.io). Это предоставляет Вам бесплатный почтовый ящик, который будет получать все электронные письма, отправленные с Вашего форума, что очень полезно для тестирования любых электронных писем, которые может отправлять Ваше новое дополнение.

```php
$config['cookie']['prefix'] = 'anything_';
```

Если Вы используете две или более установки XF на одном домене, у Вас могут возникнуть проблемы с перезаписью файлов cookie, что вызвано установками, использующими один и тот же префикс cookie. Поэтому рекомендуется менять префикс файлов cookie для каждой установленной Вами установки XF. Без этого Вы столкнетесь с проблемами, например, с выходом из одной установки XF при входе в другую.

## Предотвращение частого выхода из системы для пользователей с динамическим IP

Сессии XenForo обычно привязаны к Вашему IP-адресу. Если Ваш IP-адрес динамический или Вы используете VPN, прокси или балансировщик нагрузки, Вы можете часто выходить из системы. Вы можете предотвратить это, добавив в файл `src/config.php` следующее:
```php
$c->extend('session', function(\XF\Session\Session $session)
{
   $session->setConfig([
        'ipv4CidrMatch' => 0,
        'ipv6CidrMatch' => 0
    ]);
   return $session;
});
```

!!! warning
    Никогда не применяйте приведенный выше код к конфигурации действующего/продакшен сайта.

## Команды разработки

XF 2.0 поставляется с рядом общих команд CLI для разработки и дополнений, которые призваны помочь Вам разрабатывать более эффективно или даже, возможно, автоматизировать/сценарий для некоторых общих процессов.

В этом разделе мы рассмотрим некоторые общие инструменты и объясним, что они делают.

## Специальные команды дополнений

### Создание нового дополнения

!!! terminal
    *$* php cmd.php xf-addon:create

Команда `xf-addon:create` предназначена для первоначальной настройки и создания нового дополнения. После запуска все, что Вам нужно, это ответить на несколько основных вопросов:

* Введите идентификатор для этого дополнения
* Введите название
* Введите идентификатор версии (например, 1000010)
* Введите строку версии (например, 1.0.0 Alpha)

Затем Вам будет предоставлена возможность создать дополнение и записать его файл addon.json, а также задать несколько вопросов о том, хотите ли Вы добавить файл Setup.php.

### Экспорт _data .XML файлов

!!! terminal
    *$* php cmd.php xf-addon:export _[addon_id]_

Эту команду Вы будете использовать для экспорта всех данных дополнения в файлы XML внутри каталога `_data`. Он экспортирует данные из того, что в настоящее время находится в базе данных (а не из выходных файлов разработки).

### Поднимите версию дополнения

!!! terminal
    *$* php cmd.php xf-addon:bump-version _[addon_id]_ --version-id 1020370 --version-string 1.2.3

!!! note
	Если Ваша строка версии содержит пробелы, Вам нужно будет заключить ее в кавычки.

Эта команда принимает идентификатор дополнения для Вашего дополнения, идентификатор новой версии и строку новой версии. Это позволяет Вам обновить версию дополнения за один шаг, без необходимости выполнять обновления и перестройку самостоятельно. Приведенные выше параметры являются необязательными, и если они не указаны, Вам будет предложено их ввести. Если Вы укажете только идентификатор версии, мы попытаемся автоматически вывести из него правильную строку версии, если она соответствует нашему [Рекомендуемому формату идентификатора версии](add-on-structure.md#recommended-version-id-format). Когда команда завершится, она автоматически обновит файл `addon.json` и базу данных, указав правильную информацию о версии.

### Синхронизируйте свой addon.json с базой данных

!!! terminal
    *$* php cmd.php xf-addon:sync-json _[addon_id]_

Иногда Вы можете предпочесть отредактировать файл JSON напрямую, указав определенные детали. Это может быть версия, новая иконка, изменение названия или описания. Такое изменение JSON может привести к тому, что система дополнения будет полагать, что есть отложенные изменения или что дополнение можно обновить. Восстановление или обновление может оказаться разрушительной операцией, если Вы еще не экспортировали свои текущие данные. Поэтому рекомендуется запускать эту команду как способ импорта этих данных, не затрагивая существующие данные.

### Валидация Вашего файла addon.json

!!! terminal
    *$* php cmd.php xf-addon:validate-json _[addon_id]_

Если Вы хотите проверить, что Ваш файл JSON содержит правильное содержимое и в правильном формате, Вы можете проверить его. Валидатор проверит, можно ли декодировать контент, что он содержит все правильные обязательные поля (такие как заголовок и идентификатор версии), а также проверит наличие дополнительных ключей (таких как описание и иконка). Если какие-либо ключи отсутствуют, Вам будет предложено исправить проблему. Мы также проверяем, есть ли какие-либо неожиданные поля в файле JSON. Они могут быть преднамеренными или представлять собой опечатки. Вы можете запустить команду вручную или она будет запущена автоматически при сборке Вашего релиза.

### Запустите определенный шаг установки

Иногда полезно проверить, что шаги Вашего класса установки работают правильно, без необходимости выполнять процесс удаления и повторной установки.

В этом помогают три команды. Эти команды будут работать только с классами Setup, которые построены с использованием трейта по умолчанию `StepRunner`.

#### Запуск шага установки

!!! terminal
    *$* php cmd.php xf-addon:install-step _[addon_id]_ _[step]_

#### Запуск шага обновления

!!! terminal
    *$* php cmd.php xf-addon:upgrade-step _[addon_id]_ _[version]_ _[step]_

#### Запуск шага удаления

!!! terminal
    *$* php cmd.php xf-addon:uninstall-step _[addon_id]_ _[step]_

## Сборка релиза дополнения

После того, как вся тяжелая работа сделана, очень жаль, что Вам придется пройти через ряд других процессов, прежде чем Вы действительно сможете ее выпустить. Даже процесс сбора всех файлов в нужное место и создание ZIP-файла вручную может занять много времени и привести к ошибкам. Мы можем позаботиться об этом автоматически, включая создание файла `hashes.json`, с помощью одной простой команды.

!!! terminal
    *$* php cmd.php xf-addon:build-release _[addon_id]_

Когда Вы запустите эту команду, она сначала запустит команду `xf-addon:export`, а затем соберет все Ваши файлы во временный каталог `_build` и запишет их в ZIP-файл. Готовый ZIP-файл также будет включать файл `hashes.json`. Как только ZIP-файл будет создан, он будет сохранен в Вашем каталоге `_releases` и именем `<ADDON ID>-<VERSION STRING>.zip`.

### Настройка процесса сборки

Помимо создания ZIP релиза, могут быть дополнительные файлы, которые Вы хотите включить в свой ZIP, другие более сложные процессы сборки, которые Вы хотите запустить, такие как минимизация или объединение JS или выполнение определенных команд оболочки. Обо всем этом можно позаботиться в Вашем файле `build.json`. Это типичный файл `build.json`:

```json
{
	"additional_files": [
		"js/demo/portal"
	],
	"minify": [
		"js/demo/portal/a.js",
		"js/demo/portal/b.js"
	],
	"rollup": {
		"js/demo/portal/ab-rollup.js": [
			"js/demo/portal/a.min.js",
			"js/demo/portal/b.min.js"
		]
	},
	"exec": [
		"echo '{title} version {version_string} ({version_id}) has been built successfully!' > 'src/addons/Demo/Portal/_build/built.txt'"
	]
}
```

Если у Вас есть ресурсы, такие как JavaScript, которые необходимо обслуживать вне каталога дополнения, Вы можете указать процессу сборки копировать файлы или каталоги, используя массив `additional_files` в `build.json`. Во время разработки не всегда возможно хранить файлы вне каталога дополнения, поэтому, если Вы предпочитаете, Вы можете вместо этого хранить файлы в каталоге дополнения `_files`. При копировании дополнительных файлов мы сначала проверим их.

Если Вы отправляете некоторые файлы JS вместе с дополнением, Вы можете минифицировать эти файлы по соображениям производительности. Вы можете указать, какие файлы Вы хотите минифицировать, прямо внутри Вашего `build.json`. Вы можете перечислить их в виде массива или просто указать его как `'*'`, что минифицирует все в Вашем каталоге `js`, если этот путь содержит файлы JS после копирования дополнительных файлов в сборку. Любые минифицированные файлы будут автоматически иметь суффикс `.min.js` вместо `.js`, а исходные файлы все еще будут в пакете.

Возможно, Вы предпочтете объединить несколько файлов JS в один файл. Если Вы это сделаете, Вы можете использовать массив `rollup`, чтобы определить это. Ключ - это получившееся объединенное имя файла, а элементы в этом массиве - это пути к файлам JS, которые будут объединены в один файл.

Наконец, у Вас могут быть определенные процессы, которые необходимо запустить непосредственно перед сборкой и окончательной доработкой пакета. Это может быть любая комбинация вещей. В конечном счете, если это команда, которую можно запустить из оболочки (включая сценарии PHP), Вы можете указать ее здесь. Приведенный выше пример, конечно, бесполезен, но он, по крайней мере, демонстрирует, что можно использовать определенные заполнители. Эти заполнители заменяются скалярными значениями, которые Вы можете получить из объекта `XF\AddOn\AddOn`, который обычно представляет собой любое значение, доступное в файле `addon.json` или в объекте `AddOn`.

## Команды разработки

На самом деле существует довольно много команд, связанных с разработкой, но здесь рассматриваются только две наиболее важные.

Чтобы использовать любую из этих команд, у Вас должен быть включен [режим разработки](#enabling-development-mode) в Вашем файле `config.php`.

!!! warning
	Обе следующие команды могут потенциально вызвать потерю данных, если есть ситуация,
	когда база данных и каталог `_output` перестают синхронизироваться. 
	Всегда рекомендуется использовать VCS (систему контроля версий), такую как 
	[GitHub](https://github.com), чтобы уменьшить влияние таких ошибок.

### Импорт результатов разработки

!!! terminal
    *$* php cmd.php xf-dev:import --addon _[addon_id]_

Выполнение этой команды импортирует все выходные файлы разработки из каталога дополнения `_output` в базу данных.

### Экспорт результатов разработки

!!! terminal
    *$* php cmd.php xf-dev:export --addon _[addon_id]_

Это экспортирует все данные, которые в настоящее время связаны с Вашим дополнением в базе данных, в файлы в Вашем каталоге `_output`.

## Отладка кода

Должна быть возможность настроить Ваш любимый инструмент отладчика (XDebug, Zend Debugger и т. д.) для работы с XF2. Хотя иногда отладочный код может быть столь же рудиментарным, как и просто быстрое определение того, какое значение (или тип значения) хранится в переменной в данный момент времени.

### Дамп переменной

В PHP, конечно же, есть встроенный инструмент, позволяющий справиться с этим. Скорее всего, Вы знаете его как `var_dump()`. XF поставляется с двумя заменами для этого:

```php
\XF::dump($var);
\XF::dumpSimple($var);
```

Простая версия в основном просто выгружает значение переменной в виде обычного текста. Например, если Вы просто используете его для выгрузки значения массива, Вы увидите вывод вверху страницы, подобный этому:

```plain
array(2) {
  ["user_id"] => int(1)
  ["username"] => string(5) "Admin"
}
```

Фактически это тот же результат, что и стандартный var_dump, но немного измененный для удобства чтения и заключенный в теги `<pre>`, чтобы гарантировать сохранение пробелов при рендеринге.

Альтернативой на самом деле является компонент VarDumper из проекта Symfony. Он выводит HTML, CSS и JS для создания более функционального и потенциально более удобного для чтения вывода. Он позволяет свернуть определенные разделы, а для определенных значений, которые могут выводить значительный объем данных, таких как объекты, он может автоматически свернуть эти разделы.
